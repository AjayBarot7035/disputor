#!/usr/bin/env ruby
require "fileutils"

APP_ROOT = File.expand_path("..", __dir__)

def system!(*args)
  system(*args, exception: true)
end

def check_service(name, check_command, error_message)
  puts "Checking #{name}..."
  unless system(check_command, out: File::NULL, err: File::NULL)
    puts "WARNING: #{error_message}"
    puts "Please ensure #{name} is installed and running."
    return false
  end
  puts "#{name} is available"
  true
end

FileUtils.chdir APP_ROOT do
  puts "== Checking prerequisites =="
  ruby_version = `ruby -v`.strip
  puts "Ruby: #{ruby_version}"

  postgres_ok = check_service(
    "PostgreSQL",
    "which psql",
    "PostgreSQL is not found. Install with: brew install postgresql@16"
  )

  redis_ok = check_service(
    "Redis",
    "which redis-cli",
    "Redis is not found. Install with: brew install redis"
  )

  if redis_ok
    redis_ping = `redis-cli ping 2>&1`.strip
    if redis_ping == "PONG"
      puts "Redis is running"
    else
      puts "WARNING: Redis is installed but not running."
      puts "Start it with: brew services start redis"
    end
  end

  puts "\n== Installing dependencies =="
  system("bundle check") || system!("bundle install")

  puts "\n== Preparing database =="
  if ARGV.include?("--reset")
    system! "bin/rails db:reset"
  else
    system! "bin/rails db:prepare"
  end

  puts "\n== Removing old logs and tempfiles =="
  system! "bin/rails log:clear tmp:clear"

  puts "\n== Setup complete! =="
  puts "\nNext steps:"
  puts "  1. Create sample users: bin/rails users:sample"
  puts "  2. Start Rails server: bin/rails server"
  puts "  3. Start Sidekiq (in another terminal): bundle exec sidekiq"
  puts "\nOr use bin/dev to start the Rails server (Sidekiq runs separately)"

  unless ARGV.include?("--skip-server")
    puts "\n== Starting development server =="
    STDOUT.flush
    exec "bin/dev"
  end
end
